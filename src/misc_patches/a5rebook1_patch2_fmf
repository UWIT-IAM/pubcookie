From fmf@cac.washington.edu Tue Jun  1 17:17:04 1999
Date: Fri, 28 May 1999 14:33:27 -0700
From: Frank Fujimoto <fmf@cac.washington.edu>
To: Steve Willey <willey@cac.washington.edu>
Subject: latest set of patches for pubcookie

these are off the reebok1 sources i grabbed the other day.  note i
renamed main_rrec to top_rrec, which is a more correct term.  this is
because i needed to create a main_rrec which did go to the main request,
rather than the main request of the top request (does your brain hurt
yet?)  -fmf


*** pubcookie-a4reebok1/mod_pubcookie.c	Wed May 26 11:25:52 1999
--- mod_pubcookie.c	Fri May 28 14:27:16 1999
***************
*** 157,171 ****
  
  }
  
  /* figure out the app_id                                                      */
  unsigned char *genr_app_id(request_rec *r, pubcookie_dir_rec *cfg)
  {
  
-     return cfg->app_id ? cfg->app_id : get_app_path(r->pool, r->unparsed_uri, r->filename);
- 
  }
  
! request_rec *main_rrec (request_rec *r) {
      request_rec *mr = r;
  
      for (;;) {
--- 157,178 ----
  
  }
  
+ request_rec *main_rrec (request_rec *r) {
+     request_rec *mr = r;
+     while (mr->main)
+ 	mr = mr->main;
+     return mr;
+ }
+ 
  /* figure out the app_id                                                      */
  unsigned char *genr_app_id(request_rec *r, pubcookie_dir_rec *cfg)
  {
+     request_rec *rmain = main_rrec (r);
+     return cfg->app_id ? cfg->app_id : get_app_path(r->pool, rmain->unparsed_uri, r->filename);
  
  }
  
! request_rec *top_rrec (request_rec *r) {
      request_rec *mr = r;
  
      for (;;) {
***************
*** 183,189 ****
    const char *cookie_header; 
    char *cookie;
    char *ptr;
!   request_rec *mr = main_rrec (r);
    char *c2;
    char *name_w_eq;
  
--- 190,196 ----
    const char *cookie_header; 
    char *cookie;
    char *ptr;
!   request_rec *mr = top_rrec (r);
    char *c2;
    char *name_w_eq;
  
***************
*** 191,200 ****
  #ifdef APACHE1_2
    if(table_get(mr->notes, name) ||
        !(cookie_header = table_get(r->headers_in, "Cookie")))
  #else
    if(ap_table_get(mr->notes, name) ||
        !(cookie_header = ap_table_get(r->headers_in, "Cookie")))
- #endif
      return 0;
  
    /* if we aint got an authtype they we definately aint pubcookie */
--- 198,214 ----
  #ifdef APACHE1_2
    if(table_get(mr->notes, name) ||
        !(cookie_header = table_get(r->headers_in, "Cookie")))
+     return 0;
+ 
+   /* if we aint got an authtype they we definately aint pubcookie */
+   if(!auth_type(r))
+     return DECLINED;
+ 
+   /* add an equal on the end */
+   name_w_eq = pstrcat(r->pool, name, "=", NULL);
  #else
    if(ap_table_get(mr->notes, name) ||
        !(cookie_header = ap_table_get(r->headers_in, "Cookie")))
      return 0;
  
    /* if we aint got an authtype they we definately aint pubcookie */
***************
*** 202,210 ****
      return DECLINED;
  
    /* add an equal on the end */
- #ifdef APACHE1_2
-   name_w_eq = pstrcat(r->pool, name, "=", NULL);
- #else
    name_w_eq = ap_pstrcat(r->pool, name, "=", NULL);
  #endif
  
--- 216,221 ----
***************
*** 272,278 ****
      char		 *refresh_e;
      pubcookie_server_rec *scfg;
      pubcookie_dir_rec 	 *cfg;
!     request_rec		 *mr = main_rrec (r);
  
  #ifdef APACHE1_2
      cfg = (pubcookie_dir_rec *) get_module_config(r->per_dir_config, 
--- 283,289 ----
      char		 *refresh_e;
      pubcookie_server_rec *scfg;
      pubcookie_dir_rec 	 *cfg;
!     request_rec		 *mr = top_rrec (r);
  
  #ifdef APACHE1_2
      cfg = (pubcookie_dir_rec *) get_module_config(r->per_dir_config, 
***************
*** 346,352 ****
      table_add(r->headers_out, "Set-Cookie", new_cookie);
  
      /* we want to make sure agents don't cache the redirect */
!     table_set(r->headers_out, "Expires", libpbc_time_string(time(null)));
      table_set(r->headers_out, "Cache-Control", "no-cache");
      table_set(r->headers_out, "Pragma", "no-cache");
  
--- 357,363 ----
      table_add(r->headers_out, "Set-Cookie", new_cookie);
  
      /* we want to make sure agents don't cache the redirect */
!     table_set(r->headers_out, "Expires", libpbc_time_string(time(NULL)));
      table_set(r->headers_out, "Cache-Control", "no-cache");
      table_set(r->headers_out, "Pragma", "no-cache");
  
***************
*** 379,387 ****
      /* a bad mix of stuff here and stuff in pbc_config.h */
  #ifdef APACHE1_2
          rprintf(r, "<HTML><HEAD>\n");
!         rptintf(r, "</HEAD>\n");
          rprintf(r, "<BODY BGCOLOR=\"white\" onLoad=\"document.query.submit.click()\">\n");
!         rptintf(r, "<CENTER>\n");
  
          rprintf(r, "%s", PBC_POST_NO_JS_HTML1);
          rprintf(r, "%s", (cfg->login ? cfg->login : PBC_LOGIN_PAGE) );
--- 390,398 ----
      /* a bad mix of stuff here and stuff in pbc_config.h */
  #ifdef APACHE1_2
          rprintf(r, "<HTML><HEAD>\n");
!         rprintf(r, "</HEAD>\n");
          rprintf(r, "<BODY BGCOLOR=\"white\" onLoad=\"document.query.submit.click()\">\n");
!         rprintf(r, "<CENTER>\n");
  
          rprintf(r, "%s", PBC_POST_NO_JS_HTML1);
          rprintf(r, "%s", (cfg->login ? cfg->login : PBC_LOGIN_PAGE) );
***************
*** 399,405 ****
          rprintf(r, "%s", PBC_HTML_COPYRIGHT);
  
          rprintf(r, "%s", PBC_POST_NO_JS_HTML3);
!         rptintf(r, "</CENTER>\n");
          rprintf(r, "</BODY></HTML>\n");
  #else
          ap_rprintf(r, "<HTML><HEAD>\n");
--- 410,416 ----
          rprintf(r, "%s", PBC_HTML_COPYRIGHT);
  
          rprintf(r, "%s", PBC_POST_NO_JS_HTML3);
!         rprintf(r, "</CENTER>\n");
          rprintf(r, "</BODY></HTML>\n");
  #else
          ap_rprintf(r, "<HTML><HEAD>\n");
***************
*** 548,554 ****
  char *get_cookie(request_rec *r, char *name) {
    const char *cookie_header; 
    char *cookie, *ptr;
!   request_rec *mr = main_rrec (r);
    char *name_w_eq;
  
    /* get cookies */
--- 559,565 ----
  char *get_cookie(request_rec *r, char *name) {
    const char *cookie_header; 
    char *cookie, *ptr;
!   request_rec *mr = top_rrec (r);
    char *name_w_eq;
  
    /* get cookies */
***************
*** 957,962 ****
--- 968,974 ----
         in the app
       */
      if( cfg->inact_exp > 0 || first_time_in_session ) {
+       request_rec *rmain = main_rrec (r);
  
        /* make session cookie */
        cookie = libpbc_get_cookie_p(r->pool, (unsigned char *) r->connection->user, PBC_COOKIE_TYPE_S, cfg->creds, scfg->serial_s_sent++, scfg->appsrv_id, genr_app_id(r, cfg), scfg->session_sign_ctx_plus, scfg->c_stuff);
***************
*** 969,975 ****
  #ifdef NO_JIMB_SESSION_NAMES
                "/");
  #else
!               get_app_path(r->pool, r->unparsed_uri), r->filename);
  #endif
  
        table_add(r->headers_out, "Set-Cookie", new_cookie);
--- 981,987 ----
  #ifdef NO_JIMB_SESSION_NAMES
                "/");
  #else
!               get_app_path(r->pool, rmain->unparsed_uri, r->filename));
  #endif
  
        table_add(r->headers_out, "Set-Cookie", new_cookie);
***************
*** 981,987 ****
  #ifdef NO_JIMB_SESSION_NAMES
                "/");
  #else
!               get_app_path(r->pool, r->unparsed_uri, r->filename));
  #endif
  
        ap_table_add(r->headers_out, "Set-Cookie", new_cookie);
--- 993,999 ----
  #ifdef NO_JIMB_SESSION_NAMES
                "/");
  #else
!               get_app_path(r->pool, rmain->unparsed_uri, r->filename));
  #endif
  
        ap_table_add(r->headers_out, "Set-Cookie", new_cookie);

