<html>
	<head>
		<title>Pubcookie ISAPI Filter - Install Guide</title>
		<link rel="stylesheet" href="pubcookie.css" type="text/css" title="pubcookie">
	</head>
	<body>
		<h1>Pubcookie ISAPI Filter - Install Guide</h1>
		<p>Note: Documentation can contain bugs too. The <a href="http://www.pubcookie.org/docs/install-filter.html">
				online version of this document</a> is always the most up-to-date version.
		</p>
		<p><i>Included on this page:</i></p>
		<ul>
			<li>
				<a href="#overview">Overview</a>
			<li>
				<a href="#news">What's New</a>
			<li>
				<a href="#prereq">Prerequisites</a>
			<li>
				<a href="#sysreq">System Requirements</a>
			<li>
				<a href="#install">Install Pubcookie</a>
			<li>
				<a href="#configure">Configure Pubcookie</a>
			<li>
				<a href="#clusters">Clustered Host Configuration</a>
			<li>
				<a href="#vhosts">Multiple Web Site Configuration</a>
			<li>
				<a href="#relay">Cross-Domain Relay Configuration</a>
			<li>
				<a href="#upgrade">Upgrading</a></li>
		</ul>
		<h4><a name="overview">Overview</a></h4>
		<p>This guide helps Microsoft IIS server administrators install the Pubcookie ISAPI 
			filter, herein referred to as simply <i>the filter</i>.</p>
		<h4><a name="news">What's New</a></h4>
		<P>Significant improvements since version 3.0.0:</P>
		<UL>
			<LI>
				New Pubcookie.msi installer.
			<LI>
				New IIS MMC extension for GUI-based configuration tabs.
			<LI>
				<A href="#vhosts">Virtual host support</A>
			<LI>
				<A href="#relay">Cross-DNS-domain relay</A>
			<LI>
				New <A href="mod_pubcookie-directives.html#PubcookieNoPrompt">No_Prompt</A>
			directive
			<LI>
				Enhanced <A href="mod_pubcookie-directives.html#PubcookieSessionCauseReAuth">Session_Reauth</A>
			with grace time
			<LI>
				New <TT>keyclient -G</TT>
			option to download granting certificate
			<LI>
			Improved OpenSSL compatibility
			<LI>
				Revised, improved documentation
			</LI>
		</UL>
		<P>Note: some new features require a Pubcookie 3.1.0 or higher login server.</P>
		<h4><a name="prereq">Prerequisites</a></h4>
		<p>The filter relies on additional infrastructure at your site. Here are some 
			general prerequisites that, if fulfilled, will lead to a smooth, successful 
			installation.</p>
		<ul>
			<li>
				<p>Determine the location of your site's Pubcookie login server. The installer 
					needs this URL during installation. You may also want to find out its version, 
					so that you know what features it supports.</p>
			<li>
				<p>Determine the location of your site's Pubcookie keyserver. The installer needs 
					this URL to request a symmetric encryption key that your server will share with 
					your login server. Depending on the keyserver version and site policy, you may 
					also need to ask your administrator to "permit" your server to request keys.</p>
			<li>
				<p>Determine how trust is handled by your site's Pubcookie keyserver. You'll need 
					to know which Certificate Authorities the keyserver trusts to verify 
					certificates. Similarly, you'll need to know which Certificate Authority can 
					verify the keyserver's certificate. Ask your administrator for guidelines; 
					it'll save you time and effort.</p>
			<li>
				<p>Determine how your site distributes its Pubcookie "granting" certificate. The 
					installer needs a copy of this certificate to verify the "granting" cookies 
					signed and sent by your site's login server. The installer may be able to 
					download it from your keyserver, or you may have to obtain it manually. Ask 
					your administrator which method to use.</p>
			</li>
		</ul>
		<p>Note: Review the sections on <a href="#vhosts">virtual host configuration</a> or
                   <a href="#clusters">clustered host configuration</a> now if either of those scenarios apply. 
			The information will help you think about and tailor the installation as 
			needed.</p>
		<h4><a name="sysreq">System Requirements</a></h4>
		<p>The Pubcookie ISAPI filter has the following system requirements:</p>
		<ul>
			<li>
				<p>Microsoft Windows&nbsp;2000 or later</p>
			<li>
				<p>Microsoft Internet Information Server (IIS) 4.0 or later</p>
			<li>
				<p>Accurate system time</p>
			<li>
				<p>Domain name registered in DNS (e.g. <i>appserver.example.edu</i>).</p>
				<p>Note: If your server doesn't share a common DNS subdomain (e.g. <i>.example.edu</i>) 
					with your site's Pubcookie login server (e.g. <i>weblogin.example.edu</i>) or if
                                        your enterprise domain is in a country code top-level domain (e.g.
                                        <i>example.ca</i>) you will have to install and use the Pubcookie relay cgi to
                                        authenticate across DNS domains. Review the <a href="#relay">relay configuration</a>
                                        section now to prepare for this case.</p>
			<LI>
				<P>An SSL enabled web site. All intended users should be able to reach your website 
					via HTTPS at your registered DNS name without errors.</P>
			<LI>
				<P>The <tt>System32\Inetsrv</tt> folder should be world writable or writable by the 
					administrator account running the installer.</P>
			</LI>
		</ul>
		<h4><a name="install">Install Pubcookie</a></h4>
		<p>Open the pubcookie.msi package as the administrator user or as an account with 
			administrator privileges. The installer needs to create folders and files in 
			the <tt>System32\Inetsrv</tt> folder as well as to stop and start system 
			services.</p>
		<p>A typical installation has several stages:</p>
		<ol>
			<li>
				<p>The installer first allows you to decide to install Pubcookie, or to modify, repair, or remove Pubcookie if it 
					is already installed.</p>
			<li>
				<p>During installation, the Site Information screen collects site information. Here you'll be able to specify your server name, 
					Pubcookie login server and keyserver locations, enterprise domain, and 
					authentication types.&nbsp; Make sure that your server&nbsp;name matches the 
					certificate you installed when you set up SSL for your web site.&nbsp;</p>
			<LI>
				<P>The Custom Setup screen lets you select the ISAPI Filter and basic test Webapp for installation. You may change 
					the installation directory and change installed components. (If you need to use the Pubcookie 
                                        relay, select it to be installed; it is unselected by default.)</P>
			<li>
				<p>The installer is now ready to do the install. Click the Install button. The installer will add the Pubcookie filter to the IIS root 
					filter list and restart IIS services. It will aslo use your server name to 
					locate your SSL key pair from the&nbsp;Personal Certificate store and use them, 
					along with your installed Certificate Authority certificates, to negotiate a 
					symmetric key from your keyserver and download your site's "granting" 
					certificate.</p>
			</li>
		</ol>
		<p>Note: to request a key from your keyserver you may have to ask your keyserver 
			administrator to "permit" your host. Also, you'll need to be able to verify the 
			keyserver's SSL certificate with the CA certificates installed on your system. 
			Ask your keyserver administrator if you need a special CA certificate to do 
			that.</p>

		<h4><a name="configure">Configure Pubcookie</a></h4>
                <p>Use the IIS Service Manager to modify the configuration directives specific to Pubcookie.
                After installation, your web site's Properties sheet will have tabs for Pubcookie Server
                Values and Pubcookie Directives. Each resource under the web site will have its own Pubcookie
                Directives tab too. Examine the properties of the WebApp example application. The values you 
                provided to the installer will be the basis for what you initially see.</p>

		<h4><a name="clusters">Clustered Host Configuration</a></h4>
		<p>For clustered host configurations, run the installer on each host. After running 
			the install on the last host, copy the symmetric key (by default from <tt>System32\Inetsrv\Pubcookie\keys\</tt>) 
			on the last host installed to each of the other hosts. This will syncronize the 
			cluster with the key stored on the login server.</p>
		<h4><a name="vhosts">Multiple Web Site Configuration</a></h4>
		<P>If clients can connect to multiple web sites on your server (i.e., using more than one server 
                        name, each SSL enabled) you 
			will need to run keyclient.exe for each of the names in addition to the one you 
			specified during the installation process.&nbsp; By default, keyclient.exe 
			resides in <TT>System32\Inetsrv\Pubcookie\.</TT>&nbsp; The syntax to request an
			encryption key for a web site is:</P>
		<P><TT>keyclient -H &lt;hostname&gt;</TT></P>
		<P>where <tt>&lt;hostname&gt;</tt> is replaced with your target web site name.
			Since Pubcookie uses SSL encryption, and the keyclient uses your web sites's
                        certificate pair, you will need to have SSL access properly 
			set up for each web site in the multiple web site scenario.</P>
                <p>Additionally, to avoid conflicts between configuration directives, each web site can 
                        be assigned its own location in the Pubcookie directive database for its settings. 
                        Using the IIS Service Manager, open each site's Properties dialog. Here you will find the 
                        Pubcookie Server Values tab. Change the WebVarLocation variable from its inherited
                        default value to one specfic to each web site (e.g. 
                        <tt>System\CurrentControlSet\Services\PubcookieFilter\MySiteSettings</tt>).</p>

		<h4><a name="relay">Cross-Domain Relay Configuration</a></h4>
                <p>To install the optional Pubcookie relay for cross-DNS-domain authentication, select the
                        Relay component from the installer's Custom Setup screen. If selected, the installer 
                        adds it to your default website in <tt>PBC_RELAY</tt> in your web root folder.
                        This folder contains the relay cgi executable itself and some necessary 
                        templates. The relay cgi picks up default configuration settings from 
                        those provided to the installer. The most significant being the location
                        of your login server.</p>
                <p>To configure a resource that needs to use the relay (presumably because it's located
                        across DNS domains and therefore can't be used directly), use the IIS Service Manager to modify the resource's 
                        configuration, specifying the relay as your login server and an enterprise domain localized for the
                        occasion.</p>

                <p>For example, if your application server name is <i>remote.site.org</i> and the relay is installed as <tt>PBC_RELAY</tt> at the 
                        root of your website, open the Properties window for the resource (you might try this on the test WebApp folder) in 
                        the IIS Service Manager and
                        select the Pubcookie Directives tab. Set the "Login_URI" directive to point to the relay cgi on your application server,
                        e.g., <tt>https://remote.site.org/pbc_relay/index.cgi?domain=.site.org</tt>, and set the "Enterprise_Domain"
                        directive to <tt>.site.org</tt>.

                <p>Now the filter will redirect users to the relay first. Then the relay will handle getting them to the remote login 
                        server and back again. 

                <p>Note: The relay accepts the <tt>domain</tt> argument to allow a single relay to serve multiple servers and mulitiple domains.
                It should match your Enterprise_Domain value because the relay and the module need this to synchronize their cookie scoping. In the typical
                case it can be set to the enterprise domain you would have used if the login server had been in the same domain as your
                application server (i.e., <i>.site.org</i> in the example above). If your application server is in a country code top-level
                domain (e.g., <i>site.subdomain.example.ca</i>) then it must be adjusted; you can use the immediate subdomain (i.e.,
                <tt>domain=.subdomain.example.ca</tt>) or if the resource and relay reside on the same server, use the server name itself (i.e.,
                <tt>domain=site.subdomain.example.ca</tt>). Just be sure to synchronize it with your Enterprise_Domain value.</p>

		<h4><a name="upgrade">Upgrading</a></h4>
		<p>For the cleanest upgrade from an earlier version of Pubcookie, remove previous 
			versions before installing the current one.</p>
		<P>To remove previous versions (optional):</P>
		<ol>
			<li>
				<p>Stop IIS.</p>
			<li>
				<p>Back up and remove your existing <tt>System32\Inetsrv\Pubcookie</tt> folder.</p>
			<LI>
				<P>Start IIS.</P>
			</LI>
		</ol>
		<P>Then run the installer for Pubcookie 3.1</P>
		<p>Note: the installer won't overwrite the web properties (registry settings) 
			you've assigned to your website, folders, or resources. It will 
			however&nbsp;update the filter variables according to the login server and 
			keyserver URLs you provide to the installer.</p>
		<hr>
		<p>
			Copyright 1999-2004, University of Washington. All rights reserved.<br>
			See doc/LICENSE.txt for terms of use.
		</p>
	</body>
</html>
